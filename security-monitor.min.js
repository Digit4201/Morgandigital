class SecurityMonitor{constructor(){this.apiEndpoint='/api/security-log',this.sessionId=this.generateSecureSessionId(),this.startTime=Date.now(),this.eventQueue=[],this.maxQueueSize=50,this.flushInterval=3e4,this.config={trackUserInteractions:!0,trackSecurityEvents:!0,trackPerformance:!0,trackErrors:!0,enableAnonymization:!0},this.initializeMonitoring()}initializeMonitoring(){this.setupErrorHandling(),this.setupSecurityEventHandlers(),this.setupPerformanceMonitoring(),this.setupUserInteractionTracking(),this.startAutoFlush(),console.log('ðŸ”’ Security Monitor initialized')}setupErrorHandling(){window.addEventListener('error',e=>{this.logSecurityEvent('javascript_error',{message:this.sanitizeError(e.message),filename:this.sanitizeFilename(e.filename),lineno:e.lineno,colno:e.colno,stack:this.sanitizeStackTrace(e.error?.stack)},'medium')}),window.addEventListener('unhandledrejection',e=>{this.logSecurityEvent('unhandled_promise_rejection',{reason:this.sanitizeError(e.reason?.toString()),stack:this.sanitizeStackTrace(e.reason?.stack)},'medium')}),window.addEventListener('error',e=>{e.target!==window&&this.logSecurityEvent('resource_load_error',{tagName:e.target.tagName,src:this.sanitizeUrl(e.target.src||e.target.href),type:e.target.type},'low')},!0)}setupSecurityEventHandlers(){this.observeSecurityThreats(),this.monitorForms(),this.monitorNavigation(),this.detectDevTools()}observeSecurityThreats(){const e=new MutationObserver(e=>{e.forEach(e=>{if('childList'===e.type&&e.addedNodes.forEach(e=>{1===e.nodeType&&('SCRIPT'===e.tagName&&this.logSecurityEvent('script_injection_attempt',{src:this.sanitizeUrl(e.src),innerHTML:e.innerHTML?'present':'empty'},'high'),'IFRAME'===e.tagName&&this.logSecurityEvent('iframe_injection_attempt',{src:this.sanitizeUrl(e.src)},'high'))}),'attributes'===e.type){const t=e.target;('onclick'===e.attributeName||'onload'===e.attributeName||'onerror'===e.attributeName)&&this.logSecurityEvent('suspicious_attribute_modification',{tagName:t.tagName,attribute:e.attributeName,value:t.getAttribute(e.attributeName)?'present':'removed'},'medium')}})});e.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:['onclick','onload','onerror','src','href']})}monitorForms(){document.addEventListener('submit',e=>{const t=e.target;if('FORM'===t.tagName){this.logEvent('form_submission',{formId:t.id||'unnamed',action:this.sanitizeUrl(t.action),method:t.method,fieldCount:t.elements.length},'info');const e=t.querySelectorAll('input[type=\"hidden\"]');e.forEach(e=>{(e.name.includes('csrf')||e.name.includes('token'))&&(!e.value||e.value.length<10)&&this.logSecurityEvent('csrf_token_manipulation',{fieldName:e.name,hasValue:!!e.value},'high')})}})}monitorNavigation(){let e=location.href;const t=new MutationObserver(()=>{location.href!==e&&(this.logEvent('navigation_change',{from:this.sanitizeUrl(e),to:this.sanitizeUrl(location.href),type:'spa_navigation'},'info'),e=location.href)});t.observe(document,{subtree:!0,childList:!0}),window.addEventListener('popstate',e=>{this.logEvent('popstate_navigation',{url:this.sanitizeUrl(location.href),hasState:!!e.state},'info')})}detectDevTools(){let e=!1;const t=()=>{window.outerHeight-window.innerHeight>160||window.outerWidth-window.innerWidth>160?e||(e=!0,this.logSecurityEvent('devtools_detected',{windowSize:`${window.innerWidth}x${window.innerHeight}`,outerSize:`${window.outerWidth}x${window.outerHeight}`},'low')):e=!1};setInterval(t,1e3)}setupPerformanceMonitoring(){window.addEventListener('load',()=>{setTimeout(()=>{const e=performance.getEntriesByType('navigation')[0];e&&this.logEvent('page_performance',{domContentLoaded:Math.round(e.domContentLoadedEventEnd-e.navigationStart),loadComplete:Math.round(e.loadEventEnd-e.navigationStart),firstPaint:this.getFirstPaint(),resourceCount:performance.getEntriesByType('resource').length},'info')},100)}),this.monitorSlowResources(),this.monitorPerformanceErrors()}getFirstPaint(){const e=performance.getEntriesByType('paint').find(e=>'first-paint'===e.name);return e?Math.round(e.startTime):null}monitorSlowResources(){const e=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{e.duration>2e3&&this.logEvent('slow_resource',{name:this.sanitizeUrl(e.name),duration:Math.round(e.duration),size:e.transferSize||0,type:e.initiatorType},'warning')})});'PerformanceObserver'in window&&e.observe({entryTypes:['resource']})}monitorPerformanceErrors(){'memory'in performance&&setInterval(()=>{const e=performance.memory,t=e.usedJSHeapSize/e.totalJSHeapSize;t>.9&&this.logEvent('high_memory_usage',{used:Math.round(e.usedJSHeapSize/1048576),total:Math.round(e.totalJSHeapSize/1048576),ratio:Math.round(100*t)},'warning')},3e4)}setupUserInteractionTracking(){document.addEventListener('click',e=>{const t=e.target;('BUTTON'===t.tagName||'A'===t.tagName||t.classList.contains('btn')||t.closest('.pricing-card'))&&this.logEvent('user_interaction',{type:'click',element:t.tagName,id:t.id||null,classes:Array.from(t.classList).slice(0,3),href:this.sanitizeUrl(t.href),timestamp:Date.now()-this.startTime},'info')});let e=0;const t=()=>{const t=Math.round(window.scrollY/(document.body.scrollHeight-window.innerHeight)*100);t>=25&&e<25?this.logEvent('scroll_milestone',{depth:25},'info'):t>=50&&e<50?this.logEvent('scroll_milestone',{depth:50},'info'):t>=75&&e<75?this.logEvent('scroll_milestone',{depth:75},'info'):t>=100&&e<100&&this.logEvent('scroll_milestone',{depth:100},'info'),e=t};window.addEventListener('scroll',this.throttle(t,1e3)),setInterval(()=>{this.logEvent('session_heartbeat',{duration:Date.now()-this.startTime,isActive:this.isUserActive()},'info')},6e4)}logSecurityEvent(e,t,n='medium'){this.addToQueue({type:'security',event:e,data:this.sanitizeData(t),severity:n,timestamp:new Date().toISOString(),sessionId:this.sessionId,userAgent:this.getHashedUserAgent(),url:this.sanitizeUrl(window.location.href)})}logEvent(e,t,n='info'){this.addToQueue({type:'event',event:e,data:this.sanitizeData(t),level:n,timestamp:new Date().toISOString(),sessionId:this.sessionId,url:this.sanitizeUrl(window.location.href)})}addToQueue(e){this.eventQueue.push(e),'high'===e.severity&&this.flushLogs(),this.eventQueue.length>=this.maxQueueSize&&this.flushLogs()}async flushLogs(){if(0===this.eventQueue.length)return;const e=[...this.eventQueue];this.eventQueue=[];try{await fetch(this.apiEndpoint,{method:'POST',headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'},body:JSON.stringify({logs:e,meta:{timestamp:new Date().toISOString(),sessionId:this.sessionId,pageLoadTime:this.startTime}})})}catch(t){console.warn('Failed to send logs:',t.message),this.eventQueue=[...e,...this.eventQueue]}}startAutoFlush(){setInterval(()=>{this.flushLogs()},this.flushInterval),window.addEventListener('beforeunload',()=>{if(navigator.sendBeacon&&this.eventQueue.length>0){const e=JSON.stringify({logs:this.eventQueue,meta:{timestamp:new Date().toISOString(),sessionId:this.sessionId,reason:'page_unload'}});navigator.sendBeacon(this.apiEndpoint,e)}})}sanitizeData(e){if('object'!=typeof e||null===e)return String(e).substring(0,500);const t={};for(const[n,s]of Object.entries(e))'string'==typeof s?t[n]=s.substring(0,500):'number'==typeof s?t[n]=s:Array.isArray(s)?t[n]=s.slice(0,10):t[n]=String(s).substring(0,100);return t}sanitizeError(e){return e?String(e).substring(0,200):'unknown'}sanitizeStackTrace(e){return e?e.split('\n').slice(0,3).join('\n').substring(0,500):null}sanitizeUrl(e){if(!e)return null;try{const t=new URL(e);return t.origin+t.pathname}catch{return'invalid_url'}}sanitizeFilename(e){return e?e.split('/').pop().substring(0,100):null}generateSecureSessionId(){const e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,'0')).join('')}getHashedUserAgent(){return btoa(navigator.userAgent).substring(0,20)}isUserActive(){return!document.hidden&&'visible'===document.visibilityState}throttle(e,t){let n;return function(){const s=arguments,o=this;n||(e.apply(o,s),n=!0,setTimeout(()=>n=!1,t))}}}document.addEventListener('DOMContentLoaded',()=>{'undefined'!=typeof window&&(window.securityMonitor=new SecurityMonitor)}),'undefined'!=typeof module&&module.exports&&(module.exports=SecurityMonitor);